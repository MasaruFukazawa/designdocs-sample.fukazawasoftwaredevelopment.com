# DDD（Domain-Driven Design）設計ルール

このプロジェクトでDDD（Domain-Driven Design）に基づく設計文書を作成する際の標準ルールです。

## 基本ルール

### ファイル保存場所
- **DDD設計文書**: `docs/design/source/ddd/` ディレクトリに保存
- **索引**: `docs/design/source/ddd/index.rst` にリンクを追加

### テンプレート使用
- **基本構造**: クラス名 → 変数 → メソッドの順で記述
- **統一フォーマット**: 既存の `docs/design/source/ddd/index.rst` をベースに拡張

### 用語・設計の統一
- 新しい用語・概念は `docs/design/source/domain_model.rst` に定義を記述
- DDD設計で使用する用語は必ずdomain_modelに登録されているものを使用
- ユースケースやデータベース設計との整合性を保つ

## インプット情報と推奨ワークフロー

### 主要なインプット
1. **ユーザーストーリー**: `docs/design/source/user_story/*.rst` のAgile形式要求
2. **ドメインモデル**: `docs/design/source/domain_model.rst` に定義されたエンティティと用語
3. **ユースケース**: `docs/design/source/usecase/*.rst` に記載されたビジネスロジック
4. **データベース設計**: `docs/design/source/database/er.rst` のエンティティ関係図

### 推奨ワークフロー
1. **GitHubのissue確認**: 具体的な機能要求や技術要件の詳細を理解
2. **ユーザーストーリー参照**: DDD設計が必要な機能要求を確認
3. **ドメインモデル作成**: エンティティ・値オブジェクト・集約の設計
4. **ユースケース確認**: ビジネスロジックとドメインサービスの設計
5. **DDD設計作成**: ドメイン層の詳細設計（← このステップ）
6. **データベース設計連携**: 永続化層の設計との整合性確保

## DDD設計の作成手順

### 1. 新しいDDD設計ファイルを作成する場合

1. `docs/design/source/ddd/` ディレクトリに新しい `.rst` ファイルを作成
2. ファイル名は機能やバウンデッドコンテキスト名にする（例：`user_management.rst`, `order_processing.rst`）
3. テンプレート構造に従って作成
4. `docs/design/source/ddd/index.rst` にリンクを追加

### 2. 設計内容の記述

#### クラス設計セクション
- **エンティティ**: 一意性を持つドメインオブジェクト
- **値オブジェクト**: 不変で属性の組み合わせで定義されるオブジェクト
- **集約**: エンティティと値オブジェクトをまとめた単位
- **ドメインサービス**: エンティティや値オブジェクトに属さないビジネスロジック
- **リポジトリ**: 集約の永続化を抽象化するインターフェース

#### 各クラスの記述項目
- **クラス名**: 目的と責務を表す明確な名前
- **変数（属性）**: プロパティとその説明・型情報
- **メソッド**: 振る舞いとその処理内容・事前条件・事後条件
- **制約・ビジネスルール**: 不変条件やバリデーションルール

## ddd/index.rst 運用ルール

### 基本構成（必須維持）

```rst
DDD（Domain-Driven Design）設計
==============================================

設計文書一覧
--------------------------------------------

.. toctree::
   :maxdepth: 1

   [DDD設計ファイル名]
   template
```

### 新しいDDD設計ファイル追加時の手順

1. **「設計文書一覧」セクションに追加**
   - 新しいDDD設計ファイル（例: `user_management.rst`）を作成した場合
   - `ddd/index.rst` の「設計文書一覧」セクションの `.. toctree::` に追加
   - ファイル名は拡張子（`.rst`）を除いて記載

2. **追加順序**
   - 機能の重要度順または作成日順に配置
   - `template` は常に最後に配置

3. **記載例**:
```rst
設計文書一覧
--------------------------------------------
.. toctree::
   :maxdepth: 1

   member_registration
   user_management
   order_processing
   template
```

### セクション構成ルール

- **タイトル**: 「DDD（Domain-Driven Design）設計」で固定
- **設計文書一覧セクション**: 個別のDDD設計ファイルを一覧
- **templateファイル**: 常に最後に配置
- toctree設定: `:maxdepth: 1` を統一使用

## ファイル構造例

```
docs/design/source/ddd/
├── index.rst                    # DDD設計一覧（索引）
├── member_registration.rst      # 会員登録バウンデッドコンテキスト
├── user_management.rst          # ユーザー管理バウンデッドコンテキスト
├── order_processing.rst         # 注文処理バウンデッドコンテキスト
├── payment_handling.rst         # 決済処理バウンデッドコンテキスト
└── template.rst                 # テンプレートファイル
```

## テンプレート構造

### 基本セクション
```rst
[バウンデッドコンテキスト名]
==============================================

概要
--------------------------------------------
このバウンデッドコンテキストの目的と責務の説明

エンティティ
--------------------------------------------

**[エンティティ名]**

- ID: エンティティの一意識別子
- [属性名]: 属性の説明

**メソッド**

- [メソッド名]: メソッドの処理内容

値オブジェクト
--------------------------------------------

**[値オブジェクト名]**

- [属性名]: 属性の説明と制約

集約
--------------------------------------------

**[集約名]**

- 集約ルート: [エンティティ名]
- 含まれるオブジェクト: [リスト]
- 不変条件: [ビジネスルール]

ドメインサービス
--------------------------------------------

**[サービス名]**

- 目的: サービスの責務
- メソッド: [メソッド名とその処理内容]

リポジトリ
--------------------------------------------

**[リポジトリ名]**

- 対象集約: [集約名]
- 操作: 保存・取得・削除などの操作
```

## 品質チェック

### 作成時チェックポイント
- [ ] ドメインモデルとの整合性がある
- [ ] ユースケースのビジネスロジックが適切に反映されている
- [ ] エンティティの一意性が明確に定義されている
- [ ] 値オブジェクトの不変性が保たれている
- [ ] 集約の境界が適切に設計されている
- [ ] ビジネスルールが明確に記述されている
- [ ] `docs/design/source/ddd/index.rst`にリンクが追加されている

### レビューポイント
- [ ] ドメイン専門家の知識が適切に反映されている
- [ ] 技術的制約とビジネス要件のバランスが取れている
- [ ] 将来の変更に対して柔軟性がある
- [ ] 他のバウンデッドコンテキストとの関係が明確
- [ ] データベース設計との整合性がある

## 注意事項

- DDD設計は技術的実装よりもビジネスロジックに重点を置くこと
- ドメイン専門家とのコミュニケーションを重視すること
- バウンデッドコンテキストの境界を明確に定義すること
- 複雑さを適切に管理し、過度な抽象化を避けること
- 継続的なリファクタリングを前提とした設計にすること

## 関連文書

- `docs/design/source/domain_model.rst`: 用語定義とクラス図
- `docs/design/source/usecase.rst`: ユースケース設計
- `docs/design/source/database.rst`: データベース設計
- `.cursor/docs/design/usecase.md`: ユースケース作成ルール
- `.cursor/docs/design/database.md`: データベース設計ルール 