# メール定義書作成ルール

このプロジェクトでメール定義書を作成・管理する際の標準ルールです。

## 基本ルール

### 1. ファイル保存場所
- メール定義書ファイルは `docs/design/source/mail/` ディレクトリに保存すること
- ファイル名は内容を表す分かりやすい名前にすること（例：`user_registration_welcome.rst`, `password_reset_notification.rst`）

### 2. テンプレートの使用
- 新しいメール定義書を作成する際は、`docs/design/source/mail/template.rst` をコピーして使用すること
- テンプレートの構造を維持し、全てのセクションを埋めること
- **統一構造**：説明 → from → to → 件名 → 本文 → 変数一覧（必要に応じて）

### 3. インデックスファイルへの追加
- 作成したメール定義書ファイルは、`docs/design/source/mail/index.rst` のテーブルにリンクを追加すること
- メールタイトルと `:doc:` リンクを適切に記載すること
- テンプレートファイルは通常最後に配置すること

### 4. ユースケース記述との連携
- **重要**: 関連するユースケース記述ファイルの「メール一覧」セクションにもリンクを追加すること
- ユースケース記述の `.. list-table::` 内にメールタイトルとリンクを記載すること
- トレーサビリティ確保のため必須対応

### 5. 用語・設計の統一
- メール定義書で新しく出てきた用語は、`docs/design/source/domain_model.rst` に用語とその説明を記述すること
- 専門用語、システム固有の概念、業務用語などは必ず定義を追加すること
- ドメインモデルの用語と一貫性を保つこと

### 6. Git運用
- 新しいメール定義書ファイル追加時は適切なコミットメッセージでコミット・プッシュすること
- ファイル追加、インデックス更新、ユースケース更新は同じコミットに含めること

## インプット情報

メール定義書作成時に参照すべき情報源：

### 主要なインプット
- **GitHubのissue**: 機能要求で指定されたメール送信要件
- **ユーザーストーリー**: メール送信が含まれるユーザーストーリー
- **ユースケース記述**: メール送信が発生するユースケースの詳細
- **ドメインモデル**: 用語定義、アクター、業務概念

### 補助的なインプット
- **既存のメール定義書**: 類似機能のメール設計
- **データベース設計**: メール送信に必要なデータ項目

## 推奨ワークフロー

1. **GitHubのissue確認**
   - issue番号、タイトル、詳細内容を確認
   - メール送信要件の背景と期待される結果を理解

2. **ユーザーストーリー参照**
   - 関連するユーザーストーリーでメール送信シナリオを確認
   - メールの目的と価値を理解

3. **ユースケース記述確認**
   - メール送信が発生するユースケースの詳細フローを確認
   - メール送信タイミングと条件を把握

4. **メール定義書作成**（← このステップ）
   - `docs/design/source/mail/template.rst` をコピーして新しいファイルを作成
   - 各セクションに具体的な内容を記載
   - 必要に応じて変数一覧セクションを追加

5. **関連ファイル更新**
   - `docs/design/source/mail/index.rst` にリンクを追加
   - 関連するユースケース記述の「メール一覧」セクションにリンクを追加
   - 新しい用語を `docs/design/source/domain_model.rst` に追加

6. **Git運用**
   - 関連ファイル更新を含めてコミット
   - 「メール定義書: [メール名] - [概要説明]」形式でコミットメッセージ作成

## ファイル構造とテンプレート

### 標準構造
```
docs/design/source/mail/
├── index.rst                           # メール定義書一覧（テーブル形式）
├── template.rst                        # 統一テンプレートファイル
├── user_registration_welcome.rst       # ユーザー登録完了メール
├── password_reset_notification.rst     # パスワードリセット通知メール
└── order_confirmation.rst              # 注文確認メール
```

### テンプレート構造（`template.rst`）
```rst
メールタイトル
==============================================

説明
----------------------------------------------

from メールアドレス
----------------------------------------------
- 

to メールアドレス
----------------------------------------------
- 

件名
----------------------------------------------

本文
----------------------------------------------
```

### 拡張構造（必要に応じて追加）
```rst
変数一覧
----------------------------------------------
.. list-table::
   :header-rows: 1

   * - 変数名
     - 説明
     - 例
   * - {variable_name}
     - 変数の説明
     - サンプル値
```

## ユースケース記述との連携ルール

### ユースケース記述の「メール一覧」セクション
ユースケース記述ファイルに以下のセクションがある場合は、必ずメール定義書のリンクを追加すること：

```rst
メール一覧
--------------------------------------------

.. list-table::
   :header-rows: 1

   * - メールタイトル
     - メール定義書 リンク
   * - [メール名]
     - :doc:`../mail/[ファイル名]`
```

### 連携手順
1. **ユースケース記述確認**: `docs/design/source/usecase/*.rst` で「メール一覧」セクションを探す
2. **テーブル更新**: 該当するユースケースのメール一覧テーブルに新しいメールを追加
3. **リンク形式**: `:doc:`../mail/[ファイル名]`` 形式でリンクを記載
4. **同時コミット**: メール定義書作成とユースケース更新を同じコミットに含める

## 記述ガイドライン

### 説明セクション
- メールの目的と送信タイミングを明記
- どのような状況で送信されるかを具体的に説明
- ビジネス価値や顧客体験への影響を記載

### fromメールアドレス
- 送信元メールアドレスを列挙
- 表示名がある場合は「表示名 <メールアドレス>」形式で記載
- システム別、環境別のアドレスがある場合は併記

### toメールアドレス
- 送信先の決定方法を記載
- 複数の送信先がある場合はすべて列挙
- 条件分岐がある場合は条件も明記

### 件名
- 実際に送信される件名を記載
- 変数がある場合は `{variable_name}` 形式で記載
- 件名の意図や設計意図があれば併記

### 本文
- メール本文をそのまま記載
- 変数は `{variable_name}` 形式で記載
- reStructuredTextのコードブロック（`::`）内に記載

### 変数一覧（必要に応じて）
- メール内で使用する変数を表形式で整理
- 変数名、説明、サンプル値を記載
- データソースや取得方法も記載推奨

## 品質チェック

### 作成時チェックポイント
- [ ] GitHubのissueやユーザーストーリーと内容が一致している
- [ ] テンプレート構造に従って記述されている
- [ ] 件名と本文が具体的で実用的
- [ ] 変数名が他のメールと統一されている
- [ ] `docs/design/source/mail/index.rst`にリンクが追加されている
- [ ] 関連するユースケース記述の「メール一覧」セクションが更新されている
- [ ] ドメインモデルの用語と一貫性がある

### レビューポイント
- [ ] メール内容がユーザーフレンドリー
- [ ] ビジネス要件を満たしている
- [ ] セキュリティ・プライバシー配慮がされている
- [ ] 他のメール設計との整合性
- [ ] メール送信失敗時の考慮

## エラーハンドリング・運用ルール

### 送信失敗時の処理方針
**送信失敗時の処理**:
- メールアドレスが無効な場合: アドレス検証とユーザー通知
- 送信サーバーエラーの場合: 再送処理とアラート発行
- 変数不足の場合: データ整合性確認とエラーログ出力
- 外部依存サービス障害: フォールバック処理またはキューイング

**再送ポリシー**:
- 再送条件: 一時的エラーの場合のみ自動再送を実行
- 再送間隔: 5分、15分、60分間隔で段階的に延長
- 再送上限: 合計3回まで再送試行後、手動対応へエスカレーション
- 永続的エラー: 即座に再送停止し、管理者通知

**ログ出力ルール**:
- 成功ログ: 送信成功時はINFOレベルでログ出力（送信先、件名、送信時刻）
- 失敗ログ: 送信失敗時はERRORレベルでログ出力（失敗理由、送信先、リトライ回数）
- 監視項目: 失敗率が10%を超えた場合にアラート発行
- 個人情報: ログ内にメールアドレス以外の個人情報を含めない

### テスト要件

**機能テスト**:
- 正常系: 正常な変数値でメール送信が成功することを確認
- 異常系: 必須変数が不足している場合にエラーとなることを確認
- エラーハンドリング: 無効なメールアドレスの場合に適切にエラーハンドリングされることを確認
- 境界値: 最大文字数制限や特殊文字の処理を確認

**表示テスト**:
- マルチブラウザ: HTML版が各主要ブラウザで正常に表示される
- 文字エンコーディング: テキスト版が文字化けせずに表示される
- レスポンシブ: モバイル端末でのレスポンシブ表示が正常である
- メールクライアント: 主要メールクライアント（Outlook、Gmail、Apple Mail等）での表示確認

**セキュリティテスト**:
- XSS対策: 変数のエスケープ処理が適切に実装されている
- 情報漏洩: 機密情報の不正な露出がない
- 送信者認証: SPF/DKIM設定によるなりすまし防止が機能している
- プライバシー: 意図しない宛先への送信が発生しない

### 運用・保守ルール

**配信統計・分析**:
- 送信成功率: 送信成功率の監視と記録（目標値: 95%以上）
- 開封率・クリック率: 計測可能な場合は開封率・クリック率を記録
- バウンス率: バウンス率の監視とアドレス無効化処理（目標値: 5%以下）
- 配信遅延: 送信処理から実際の配信までの遅延時間を監視

**メンテナンス**:
- テンプレート見直し: 四半期ごとにテンプレートの定期的な見直しを実施
- 法的要件対応: 法的要件変更時の対応手順を明確化し、迅速に対応
- デザイン更新: デザイン更新時の影響範囲確認とテスト計画策定
- パフォーマンス: 送信処理性能の定期的な見直しと最適化

**個人情報保護**:
- ログ保存期間: メール送信ログの保存期間は1年間とし、期限後は自動削除
- 退会時処理: 退会時のメールアドレス削除手順を明確化し、確実に実行
- 情報開示禁止: 第三者への情報開示禁止の徹底と社内教育
- アクセス制御: メール送信システムへのアクセス権限を最小限に制限

**法的要件**:
- 特定電子メール法: 特定電子メール法への準拠確認と定期的な見直し
- 配信停止機能: 配信停止機能の提供義務を満たす実装と運用
- 個人情報保護法: 個人情報保護法への準拠確認と監査対応
- 国際法対応: GDPR等の国際的な法規制への対応（該当する場合）

## ファイル命名規則

### 推奨命名パターン
- `[機能名]_[メール種別].rst`
- `[アクション]_[対象]_[通知タイプ].rst`

### 命名例
- `user_registration_welcome.rst` - ユーザー登録完了メール
- `password_reset_confirmation.rst` - パスワードリセット確認メール
- `order_payment_success.rst` - 注文決済完了メール
- `contact_form_auto_reply.rst` - お問い合わせ自動返信メール
- `newsletter_weekly_digest.rst` - 週次ニュースレター

## 注意事項

### 必須事項
- テンプレート構造を必ず守ること
- ユースケース記述との連携を忘れないこと
- 新しい用語は必ずドメインモデルに定義すること
- メール内容は実装可能なレベルの詳細度を保つこと

### 品質向上のために
- 実際の運用を想定した具体的な内容にすること
- ユーザー体験を考慮したメール設計にすること
- セキュリティ・プライバシーに配慮すること
- チームメンバーとの用語統一を図ること

## mail/index.rst 運用ルール

### 基本構成（必須維持）

```rst
メール定義書 一覧
============================================

.. list-table::
   :header-rows: 1

   * - メールタイトル
     - リンク
   * - [メール名]
     - :doc:`[ファイル名]`
   * - テンプレート
     - :doc:`template`
```

### 新しいメール定義書追加時の手順

1. **list-table に行を追加**
   - 新しいメール定義書ファイル（例: `password_reset.rst`）を作成した場合
   - `mail/index.rst` の list-table に新しい行を追加
   - メールタイトルとリンクを記載

2. **追加順序**
   - 機能の重要度順または作成日順に配置
   - `template` は常に最後に配置

3. **記載例**:
```rst
.. list-table::
   :header-rows: 1

   * - メールタイトル
     - リンク
   * - 会員登録確認メール
     - :doc:`member_registration_confirmation`
   * - パスワードリセット通知メール
     - :doc:`password_reset_notification`
   * - テンプレート
     - :doc:`template`
```

### セクション構成ルール

- **タイトル**: 「メール定義書 一覧」で固定
- **list-table形式**: toctree ではなく表形式で一覧表示
- **templateファイル**: 常に最後に配置
- **ヘッダー**: 「メールタイトル」「リンク」の2列構成

## 関連文書

- **ユーザーストーリー作成**: `.cursor/user_story.md`
- **ユースケース作成**: `.cursor/usecase.md`
- **ドメインモデル作成**: `.cursor/domain_model.md`
- **統一ワークフロー**: `.cursor/workflow.md`
- **Git運用**: `.cursor/git.md`

## トラブルシューティング

### よくある問題と対処法

#### ユースケース記述に「メール一覧」セクションがない場合
```rst
メール一覧
--------------------------------------------

.. list-table::
   :header-rows: 1

   * - メールタイトル
     - メール定義書 リンク
```
上記のセクションをユースケース記述に追加してからメールリンクを記載する。

#### 変数名の統一ができていない場合
- 既存のメール定義書で使用されている変数名を確認
- 同じ概念には同じ変数名を使用（例: `{user_name}`, `{customer_email}`）
- 新しい変数を導入する場合はドメインモデルで定義

#### メール内容が技術的すぎる場合
- ユーザー視点での分かりやすい表現に修正
- 専門用語には説明を併記
- 必要に応じてドメインモデルで用語定義を追加 