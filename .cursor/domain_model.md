# ドメインモデル作成ルール

このプロジェクトでドメインモデルを作成・更新する際の標準ルールです。

## 基本ルール

### 1. ファイル保存場所
- ドメインモデル定義: `source/domain_model.rst`（単一ファイル管理）
- 用語・概念の統一管理を目的とする

### 2. 設計パターンの適用
- **ECBパターン（Entity-Control-Boundary）**: システム要素の責務分離
- **DDD（ドメイン駆動設計）**: ビジネス概念と値オブジェクトの明確化
- **統一ワークフロー**: issue → ユーザーストーリー → **ドメインモデル** → ユースケース

### 3. 用語・概念の統一
- 新しいアクター、エンティティ、用語は必ずドメインモデルに定義
- プロジェクト全体で一貫した用語を使用
- 設計パターン別の分類を維持

### 4. Git運用
- ドメインモデル更新時は適切なコミットメッセージでコミット・プッシュ
- 関連する他の設計文書と同時に更新する場合は同じコミットに含める

## インプット情報

ドメインモデル作成時に参照すべき情報源：

### 主要なインプット
- **GitHubのissue**: 機能要求で出現する業務概念
- **ユーザーストーリー**: Agile形式で記述された要求から抽出される用語・アクター
- **既存のドメインモデル**: 用語・概念の統一性維持

### 補助的なインプット
- **業務知識**: ドメインエキスパートからの情報
- **既存システム**: レガシーシステムで使用されている用語

## 推奨ワークフロー

1. **GitHubのissue確認**: 機能要求の詳細を理解
2. **ユーザーストーリー参照**: 前ステップで作成されたユーザーストーリーを確認
3. **ドメインモデル作成**（← このステップ）
   - 新しい用語・アクター・概念を抽出
   - 設計パターン別に分類
   - `source/domain_model.rst` を更新
   - 必要に応じてMermaidクラス図を作成・更新
4. **ユースケース作成**: ドメインモデルに基づいてユースケースを設計
5. **データベース設計**: エンティティからテーブル設計に展開

## 設計パターン別分類

### エンティティ（Entity）
**特徴**: 
- 一意性を持つオブジェクト（IDで識別）
- ライフサイクルがある
- 状態変更が可能

**判断基準**:
- 「このオブジェクトは他と区別できる一意性があるか？」
- 「時間経過とともに状態が変わるか？」

**記述ルール**:
- エンティティ名（日本語・英語併記）
- 主要属性（ID、基本情報、状態）
- 主要操作（メソッド相当）

### コントローラ（Controller）
**特徴**:
- ビジネスロジックの実行
- エンティティ間の協調制御
- ワークフローの管理

**判断基準**:
- 「このロジックは複数のエンティティにまたがるか？」
- 「ビジネスルールの実行責任を持つか？」

**記述ルール**:
- 管理対象の明確化
- 主要な処理フロー
- 制御するビジネスルール

### バウンダリ（Boundary）
**特徴**:
- システム境界での入出力処理
- 外部システムとの連携
- ユーザーインターフェース

**判断基準**:
- 「外部システムとの通信を行うか？」
- 「ユーザーからの入力を受け付けるか？」

**記述ルール**:
- 連携先システム・UI
- 入出力データ形式
- プロトコル・インターフェース

### ビジネス概念（Domain Concepts）
**特徴**:
- ドメイン固有のビジネスルール
- 業務知識の明文化
- システム横断的な概念

**判断基準**:
- 「業務特有の重要な概念か？」
- 「システム全体で共通理解が必要か？」

**記述ルール**:
- ビジネス上の意味・価値
- 適用条件・制約
- 関連する他の概念

### 値オブジェクト（Value Objects）
**特徴**:
- 不変オブジェクト
- 値による等価性判断
- 型安全性の向上

**判断基準**:
- 「値そのものが重要で、同一性は不要か？」
- 「不変であるべきか？」

**記述ルール**:
- 値の形式・制約
- バリデーションルール
- 不変性の保証

## Mermaidクラス図作成ルール

### 基本記法（Sphinx環境対応）
```mermaid
%%{init: {"theme": "default"}}%%
classDiagram
    class EntityName["エンティティ名"] {
        +attribute1: type
        +attribute2: type
        --
        +method1()
        +method2()
    }
```

### 推奨記法
- **クラス定義**: `class EntityName["日本語名"]`
- **属性**: `+attribute_name: data_type`
- **メソッド**: `+methodName()`
- **リレーション**: `ClassA --> ClassB`（シンプルな矢印）

### 避けるべき記法
- 複雑なリレーション記法（`||--||`、`||--o{`など）
- 日本語ラベル付きリレーション（`: "関係名"`）
- 点線矢印（`-.->` ）
- 絵文字やスペシャル文字

## ファイル構造

```
source/domain_model.rst
├── アクター
├── エンティティ（Entity）
├── コントローラ（Controller）
├── バウンダリ（Boundary）
├── ビジネス概念（Domain Concepts）
├── 値オブジェクト（Value Objects）
└── ドメインモデル クラス図
```

## 品質チェック

### 作成時チェックポイント
- [ ] ユーザーストーリーの新しい用語がすべて定義されている
- [ ] 設計パターン別の分類が適切にされている
- [ ] アクターが明確に識別されている
- [ ] エンティティに一意性（ID）が定義されている
- [ ] 値オブジェクトの不変性が明記されている
- [ ] Mermaidクラス図がSphinx環境で表示される

### レビューポイント
- [ ] 用語の一貫性が保たれている
- [ ] ビジネス価値が明確に示されている
- [ ] 設計パターンの適用が適切
- [ ] クラス図が論理的に整合している
- [ ] 他の設計文書との整合性がある

## 他の設計文書との連携

### ユーザーストーリーとの関係
- ユーザーストーリーで出現した新しい用語・アクターを定義
- As a **[アクター]** の部分はドメインモデルのアクターと一致させる
- ビジネス価値をドメイン概念として抽象化

### ユースケースとの関係
- ドメインモデルのアクターをユースケースで使用
- エンティティとコントローラがユースケースのロジックに対応
- 用語の一貫性を保つ

### データベース設計との関係
- エンティティがテーブル設計の基準となる
- 値オブジェクトがカラム設計に影響
- リレーションシップがER図に反映

## 設計パターン判断フローチャート

```mermaid
%%{init: {"theme": "default"}}%%
flowchart TD
    A[新しい概念が出現] --> B{一意性があるか？}
    B -->|Yes| C{状態変更があるか？}
    B -->|No| D{値として扱うか？}
    
    C -->|Yes| E[Entity]
    C -->|No| F{複数Entityを制御？}
    
    D -->|Yes| G[Value Object]
    D -->|No| H[Domain Concept]
    
    F -->|Yes| I[Controller]
    F -->|No| J{外部との境界？}
    
    J -->|Yes| K[Boundary]
    J -->|No| H
```

## 注意事項

### 必須事項
- 新しい用語は必ずドメインモデルに定義すること
- 設計パターンの分類を必ず実施すること
- ユーザーストーリーとの整合性を保つこと
- Mermaid図はSphinx環境で動作する形式を使用すること

### 品質向上のために
- ビジネス価値を常に意識すること
- ドメインエキスパートとの対話を重視すること
- 実装可能性を考慮すること
- チームメンバーとの用語統一を図ること

## よくある問題と解決方法

### 用語の重複・不一致
**問題**: 同じ概念が複数の名前で定義される  
**解決**: 定期的に用語集をレビューし、統合・整理する

### 設計パターンの判断迷い
**問題**: EntityかValue Objectか判断に迷う  
**解決**: 判断フローチャートを参照し、一意性と不変性で判断

### Mermaid図の表示エラー
**問題**: クラス図が正しく表示されない  
**解決**: 推奨記法を使用し、複雑な記法を避ける

### 他文書との不整合
**問題**: ユースケースで使用される用語がドメインモデルにない  
**解決**: 設計文書作成時にドメインモデルを必ず参照・更新

## 関連文書

- **統一ワークフロー**: `.cursor/workflow.md`
- **ユーザーストーリー作成**: `.cursor/user_story.md`
- **ユースケース作成**: `.cursor/usecase.md`
- **データベース設計**: `.cursor/database.md`
- **Git運用**: `.cursor/git.md` 