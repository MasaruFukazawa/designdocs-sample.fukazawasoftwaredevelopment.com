# ユースケース図・記述作成ルール

## 基本ルール

### ファイル保存場所
- **ユースケース図**: `source/usecase/diagram.rst` またはメイン図として
- **個別ユースケース記述**: `source/usecase/` ディレクトリに個別ファイル
- **索引**: `source/usecase.rst` に新ファイルのリンクを追加

### テンプレート使用
- **ユースケース図**: `source/usecase/diagram.rst` をベースに作成
- **ユースケース記述**: `source/usecase/template.rst` をコピーして使用

### 用語・アクター統一
- 新しい用語・アクターは `source/domain_model.rst` に定義を記述
- ユースケースで使用するアクター名・用語は必ずdomain_modelに登録されているものを使用

## インプット情報と推奨ワークフロー

### 主要なインプット
1. **GitHubのissue**: 具体的な機能要求や不具合報告
2. **ユーザーストーリー**: `source/user_story/*.rst` に記載された要求（Agile形式）
3. **ドメインモデル**: `source/domain_model.rst` に定義されたアクターと用語、クラス図

### 推奨ワークフロー
1. **GitHubのissue確認**: 具体的な機能要求や不具合報告の詳細を理解
2. **ユーザーストーリー作成**: issue基準でAgile形式（As a/I want/So that + Given-When-Then）のユーザーストーリーを作成
3. **ドメインモデル作成**: アクターと用語を定義し、クラス図を作成
4. **ユースケース作成**: ユースケース図・記述を作成（← このステップ）
5. **データベース設計**: 必要に応じてER図とテーブル設計を作成

## テンプレート形式

```rst
ユースケース図
============================================

[ アクター名 ] が行えるユースケース
--------------------------------------------

.. mermaid::

   %%{init: {"theme": "default"}}%%
   graph TB
       %% アクター定義
       Actor["🔸<br/>[ アクター名 ]"]
       
       %% ユースケース定義
       UseCase1["[ ユースケース1 ]"]
       UseCase2["[ ユースケース2 ]"]
       
       %% アクターとユースケースの関係
       Actor -.-> UseCase1
       Actor -.-> UseCase2
```

## 作成手順

### 1. GitHubのissueからユースケース図を作成する場合

1. GitHubのissueを確認し、アクターとユースケースを特定
2. `source/usecase/diagram.rst` のテンプレートを使用
3. アクター毎にセクションを分けて図を作成
4. 新しい用語があれば `source/domain_model.rst` に追加
5. `source/usecase.rst` にリンクを追加

### 2. 新しいユースケース図ファイルを作成する場合

1. `source/usecase/` ディレクトリに新しい `.rst` ファイルを作成
2. テンプレート形式に従って作成
3. `source/usecase.rst` にリンクを追加

## アクターアイコン

- 👤 一般ユーザー（顧客、利用者）
- 👥 管理者、運営者
- 🖥️ システム、外部システム
- 🔸 その他のアクター

## Mermaid記法のポイント（Sphinx + reStructuredText対応）

### 推奨記法（Sphinx環境で確実に動作）
- **シンプルな矢印**: `Actor --> UseCase` （実線矢印）
- **アクター定義**: `ActorName[表示名]` （シンプルな形式）
- **ユースケース定義**: `UseCaseName[ユースケース名]` （シンプルな形式）

### 使用可能なグラフタイプ
- **フローチャート**: `graph TD` （上から下）, `graph LR` （左から右）
- **シンプルな図**: 複雑なER図記法やクラス図記法は避ける

### 避けるべき記法
- **点線矢印**: `-.->` （Sphinx環境でエラーの可能性）
- **複雑なリレーション**: `||--||`, `||--o{` など
- **日本語ラベル付きリレーション**: `: "日本語"` （エラーの原因）
- **絵文字**: `🔸` など（環境によって表示されない）

### 推奨テンプレート例
```mermaid
%%{init: {"theme": "default"}}%%
graph TD
    Customer[ECサイト顧客]
    Admin[ECサイト運営者]
    
    Customer --> AddToCart[商品をカートに登録]
    Customer --> ViewCart[カートを確認]
    Customer --> Checkout[購入手続き]
    
    Admin --> ManageProducts[商品管理]
    Admin --> ViewOrders[注文確認]
```

## ファイル構造例

```
source/usecase/
├── diagram.rst          # メインのユースケース図
├── shopping_flow.rst    # ショッピングフロー図
└── admin_tasks.rst      # 管理者タスク図
```

## 注意事項

1. **アクター毎に分離**: 一つの図にすべてのアクターを入れず、アクター毎に分けて見やすくする
2. **簡潔な表現**: ユースケース名は動詞で始まり、簡潔に表現する
3. **日本語と英語**: 必要に応じて英語併記も可能
4. **一貫性**: 同じプロジェクト内では用語とスタイルを統一する
5. **更新**: issueやユーザーストーリーの変更に応じて図も更新する

---

# ユースケース記述作成ルール

## 基本ルール

### ファイル管理
1. **ファイル保存場所**: `source/usecase/` ディレクトリに保存
2. **テンプレート使用**: `source/usecase/template.rst` をコピーして使用
3. **ファイル命名規則**: `[ 機能名 ]_[ 動作 ].rst` （例: `shopping_cart_registration.rst`）
4. **索引への追加**: `source/usecase.rst` にリンクを追加

### 用語・設計統一
5. **ドメインモデル連携**: 新しいアクターや用語は `source/domain_model.rst` に定義を追加
6. **データベース連携**: データ構造が関わる場合は `source/database/er.rst` も参照・更新
7. **ユーザーストーリー連携**: 対応する `source/user_story/*.rst` を参照

### Git運用
8. **コミット**: ユースケース作成時は関連ファイル更新も含めてコミット
9. **メッセージ**: 「ユースケース: [機能名] - [概要説明]」形式

## テンプレート構造

```rst
[ ユースケース名 ]
==========================================

アクター
--------------------------------------------
**主アクター**: [ メインのアクター名 ]
**副アクター**: [ サポートするアクター名（複数可）]

事前条件
--------------------------------------------
- [ 条件1 ]
- [ 条件2 ]

事後条件
--------------------------------------------
**成功時**:
- [ 成功時の状態1 ]
- [ 成功時の状態2 ]

**失敗時**:
- [ 失敗時の状態 ]

基本コース
--------------------------------------------
1. [ アクター ] が [ アクション ] する
2. システムが [ 処理 ] する
...
8. ユースケース終了

代替コース
--------------------------------------------
**[ ステップ番号 ]a. [ 例外状況 ]の場合**:
[ ステップ番号 ]a1. [ 例外処理1 ]
[ ステップ番号 ]a2. [ 例外処理2 ]
[ ステップ番号 ]a3. ユースケース終了

シーケンス図
--------------------------------------------
.. mermaid::
   [ Mermaidシーケンス図 ]
```

## 作成手順

### 1. GitHubのissueからユースケース記述を作成する場合

1. **インプット情報の収集**:
   - GitHubのissueの内容を確認
   - 関連する `source/user_story/*.rst` のユーザーストーリーを参照（As a/I want/So that + Given-When-Then形式）
   - `source/domain_model.rst` でアクターと用語の定義、クラス図を確認
   - 必要に応じて `source/database/er.rst` でデータ構造を確認

2. **ユースケースの分析**:
   - **主アクター**: ユーザーストーリーの「As a」から特定
   - **目的**: ユーザーストーリーの「So that」から特定
   - **具体的な行動**: ユーザーストーリーの「I want」から特定
   - **シナリオ**: Given-When-Then形式の受け入れ条件を参照

3. **ファイル作成**:
   - `source/usecase/template.rst` をコピーして新しいファイルを作成
   - ファイル名は `[ 機能名 ]_[ 動作 ].rst` 形式で命名

4. **記述作成**:
   - テンプレートの各セクションを具体的に記述
   - ユーザーストーリーの受け入れ条件（Given-When-Then）を基本コースに反映
   - ドメインモデルクラス図とER図の整合性を確認

5. **関連ファイル更新**:
   - 新しいアクターや用語を `source/domain_model.rst` に追加
   - データベース関連の場合は `source/database/er.rst` も更新検討
   - `source/usecase.rst` にリンクを追加

6. **Git運用**:
   - 関連ファイル更新を含めてコミット
   - 「ユースケース: [機能名] - [概要説明]」形式でコミットメッセージ作成

### 2. 各セクションの記述ガイドライン

#### アクター
- **主アクター**: ユースケースを開始するアクター（必須）
- **副アクター**: システムや外部サービスなど、処理に関わるアクター

#### 事前条件
- ユースケース開始前に満たされている必要がある条件
- システムの状態、ユーザーの状態、データの状態など

#### 事後条件
- **成功時**: ユースケースが正常終了した場合の状態
- **失敗時**: ユースケースが異常終了した場合の状態

#### 基本コース
- 正常なシナリオでの処理手順
- ステップは動作の順序で番号付け
- 最後は「ユースケース終了」で締める

#### 代替コース
- エラーや例外的な状況での処理手順
- 基本コースのステップ番号 + a, b, c... で識別
- 各代替コースは独立して記述

#### シーケンス図
- MermaidのsequenceDiagramを使用
- アクター、UI、コントローラー、サービス、データベースなどの相互作用を表現

## ユースケース名の命名規則

- **動詞 + 目的語**の形式で命名
- 例: 「商品をカートに登録する」「ユーザー情報を更新する」「注文履歴を表示する」

## 代替コースのパターン

1. **入力エラー**: 不正な入力値による例外処理
2. **システムエラー**: サーバーエラーやネットワークエラー
3. **権限エラー**: アクセス権限不足による例外処理
4. **データ不整合**: 期待するデータが存在しない場合
5. **外部システムエラー**: 連携する外部システムの障害

## 品質チェックポイント

1. **完全性**: すべてのセクションが適切に記述されているか
2. **明確性**: 曖昧な表現がなく、具体的に記述されているか
3. **一貫性**: 用語やアクター名が統一されているか
4. **実装可能性**: 実際の開発で使用できるレベルの詳細度か
5. **保守性**: 要件変更時に修正しやすい構造になっているか

## 関連ファイル

- `source/usecase.rst` - ユースケース図・記述の索引
- `source/usecase/template.rst` - ユースケース記述テンプレート  
- `source/usecase/diagram.rst` - ユースケース図テンプレート
- `source/domain_model.rst` - プロジェクト用語定義
- `source/user_story.rst` - ユーザーストーリー
- `.cursor/user_story.md` - ユーザーストーリー作成ルール

## 用語・アクター名の統一ルール

- **アクター名**: `source/domain_model.rst` のアクターセクションに定義されている名称を使用
- **専門用語**: `source/domain_model.rst` の用語セクションに定義されている用語を使用  
- **新しいアクター・用語**: ユースケース作成前に必ず `source/domain_model.rst` に追加してから使用
- **表記揺れ防止**: 同じ概念に対して複数の表現を使わず、domain_modelの定義に統一
